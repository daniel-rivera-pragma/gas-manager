import js from '@eslint/js'
import tseslint from 'typescript-eslint'
import jsdoc from 'eslint-plugin-jsdoc'
import prettierPlugin from 'eslint-plugin-prettier'
import gasPlugin from 'eslint-plugin-googleappsscript'
import jestPlugin from 'eslint-plugin-jest'
import globals from 'globals'

/** @returns {Promise<import('eslint').Linter.Config[]>} */
async function buildConfig() {
  const prettierConfigs = prettierPlugin.configs ?? {
    recommended: { rules: {} },
  }
  let prettierRules = {}
  if (Array.isArray(prettierConfigs.recommended)) {
    for (const element of prettierConfigs.recommended) {
      prettierRules = { ...prettierRules, ...element }
    }
  } else {
    prettierRules = { ...prettierRules, ...prettierConfigs.recommended.rules }
  }
  return [
    {
      ignores: ['node_modules/', 'coverage/', '.vscode/', '.gemini/'],
    },
    {
      files: ['**/*.js'],
      plugins: {
        jsdoc: jsdoc,
        prettier: prettierPlugin,
      },
      languageOptions: {
        ecmaVersion: 'latest',
        sourceType: 'module',
        globals: {
          ...globals.browser,
          ...globals.node,
          ...gasPlugin.environments.googleappsscript.globals,
        },
      },
      rules: {
        ...js.configs.recommended.rules,
        ...jsdoc.configs['flat/recommended-typescript-flavor'].rules,
        ...prettierRules,
        'jsdoc/require-jsdoc': 'off',
        'jsdoc/require-param-description': 'off',
        'jsdoc/require-returns-description': 'off',
        'no-unused-vars': 'off',
        'no-undef': 'off',
      },
    },
    ...tseslint.configs.recommended.map((config) => ({
      ...config,
      files: ['**/*.ts'],
    })),
    {
      files: ['**/*.ts'],
      plugins: {
        jsdoc: jsdoc,
        prettier: prettierPlugin,
      },
      languageOptions: {
        parserOptions: {
          project: './jsconfig.json',
        },
        globals: {
          ...globals.browser,
          ...globals.node,
        },
      },
      rules: {
        ...jsdoc.configs['flat/recommended-typescript-flavor'].rules,
        ...prettierRules,
        'jsdoc/require-jsdoc': 'off',
        'jsdoc/require-param-description': 'off',
        'jsdoc/require-returns-description': 'off',
      },
    },
    {
      files: ['**/*.test.js'],
      plugins: {
        jest: jestPlugin,
      },
      languageOptions: {
        globals: {
          ...jestPlugin.environments.globals.globals,
        },
      },
      rules: {
        ...jestPlugin.configs['flat/recommended'].rules,
      },
    },
  ]
}

export default buildConfig()
